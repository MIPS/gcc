Needs upstreaming. Needs merging with other patches
