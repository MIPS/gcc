Upstream complete.

This patch was merged with 04dd084
