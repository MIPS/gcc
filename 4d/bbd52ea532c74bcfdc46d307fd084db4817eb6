Upstream complete. Part of compact branch support.
