Dropped from upstreaming. Needs checking because of major changes in this area.
