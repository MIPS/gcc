Needs upstreaming. Merge with 4697776
