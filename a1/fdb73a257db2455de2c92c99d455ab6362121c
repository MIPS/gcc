Dropped from upstream. Partially backported from trunk.
