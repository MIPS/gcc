Dropped from upstream.  Backported but heavily modified.
