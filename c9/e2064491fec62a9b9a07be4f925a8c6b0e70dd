Needs upstreaming. Needs combining into one patch with latest changes.
