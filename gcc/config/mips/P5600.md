;; DFA-based pipeline description for P5600.
;;
;; Copyright (C) 2014 Free Software Foundation, Inc.
;;
;; This file is part of GCC.
;;
;; GCC is free software; you can redistribute it and/or modify it
;; under the terms of the GNU General Public License as published
;; by the Free Software Foundation; either version 3, or (at your
;; option) any later version.

;; GCC is distributed in the hope that it will be useful, but WITHOUT
;; ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
;; or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public
;; License for more details.

;; You should have received a copy of the GNU General Public License
;; along with GCC; see the file COPYING3.  If not see
;; <http://www.gnu.org/licenses/>.

(define_automaton "apache_agen_pipe, apache_alu_pipe, apache_fpu_pipe")

;; The address generation queue (AGQ) has AL2, CTISTD and LDSTA pipes.
(define_cpu_unit "apc_agq, apc_agq_al2, apc_agq_ctistd, apc_agq_ldsta,
		  apc_agq_div" "apache_agen_pipe")

;; The arithmetic-logic-unit queue (ALQ) has ALU pipes.
(define_cpu_unit "apc_alq, apc_alq_alu" "apache_alu_pipe")

;; The floating-point-unit queue (FPQ) has short and long pipes.
(define_cpu_unit "apc_fpu_short, apc_fpu_long" "apache_fpu_pipe")

;; Short FPU pipeline.
(define_cpu_unit "apc_fpu_intadd, apc_fpu_cmp, apc_fpu_float, apc_fpu_logic_a,
		  apc_fpu_logic_b, apc_fpu_div, apc_fpu_store"
		 "apache_fpu_pipe")

;; Long FPU pipeline.
(define_cpu_unit "apc_fpu_logic, apc_fpu_float_a, apc_fpu_float_b,
		  apc_fpu_float_c, apc_fpu_float_d" "apache_fpu_pipe")
(define_cpu_unit "apc_fpu_mult, apc_fpu_fdiv, apc_fpu_load, apc_fpu_apu"
		 "apache_fpu_pipe")

(define_reservation "agq_al2" "apc_agq, apc_agq_al2")
(define_reservation "agq_ctistd" "apc_agq, apc_agq_ctistd")
(define_reservation "agq_ldsta" "apc_agq, apc_agq_ldsta")
(define_reservation "alq_alu" "apc_alq, apc_alq_alu")

;;
;; FPU-MSA pipe
;;

;; Arithmetic
;; add, hadd, sub, hsub, average, min, max, compare
(define_insn_reservation "msa_short_int_add" 2
  (eq_attr "msa_execunit" "msa_eu_int_add")
  "apc_fpu_short, apc_fpu_intadd")

;; Bitwise Instructions
;; and, or, xor, bit-clear, leading-bits-count, shift, shuffle
(define_insn_reservation "msa_short_logic" 2
  (eq_attr "msa_execunit" "msa_eu_logic")
  "apc_fpu_short, apc_fpu_logic_a")

;; move.v
(define_insn_reservation "msa_short_logic_move_v" 2
  (and (eq_attr "type" "fmove")
    (eq_attr "mode" "TI"))
  "apc_fpu_short, apc_fpu_logic_a")

;; Float compare
(define_insn_reservation "msa_short_cmp" 2
  (eq_attr "msa_execunit" "msa_eu_cmp")
  "apc_fpu_short, apc_fpu_cmp")

;; Float exp2, min, max
(define_insn_reservation "msa_short_float2" 2
  (eq_attr "msa_execunit" "msa_eu_float2")
  "apc_fpu_short, apc_fpu_float")

;; Vector sat
(define_insn_reservation "msa_short_logic3" 3
  (eq_attr "msa_execunit" "msa_eu_logic3")
  "apc_fpu_short, apc_fpu_logic_a, apc_fpu_logic_b")

;; Vector copy, bz, bnz
(define_insn_reservation "msa_short_store4" 4
  (eq_attr "msa_execunit" "msa_eu_store4")
  "apc_fpu_short, apc_fpu_store")

;; Vector load
(define_insn_reservation "msa_long_load" 10
  (and (eq_attr "type" "fpload")
    (eq_attr "mode" "TI"))
  "apc_fpu_long, apc_fpu_load")

;; Vector store
(define_insn_reservation "msa_short_store" 2
  (and (eq_attr "type" "fpstore")
    (eq_attr "mode" "TI"))
  "apc_fpu_short, apc_fpu_store")

;; binsl, binsr, insert, vshf, sld
(define_insn_reservation "msa_long_logic" 2
  (eq_attr "msa_execunit" "msa_eu_logic_l")
  "apc_fpu_long, apc_fpu_logic")

;; Float fclass, flog2
(define_insn_reservation "msa_long_float2" 2
  (eq_attr "msa_execunit" "msa_eu_float2_l")
  "apc_fpu_long, apc_fpu_float_a")

;; fadd, fsub
(define_insn_reservation "msa_long_float4" 4
  (eq_attr "msa_execunit" "msa_eu_float4")
  "apc_fpu_long, apc_fpu_float_a, apc_fpu_float_b")

;; fmul
(define_insn_reservation "msa_long_float5" 5
  (eq_attr "msa_execunit" "msa_eu_float5")
  "apc_fpu_long, apc_fpu_float_a, apc_fpu_float_b, apc_fpu_float_c")

;; fmadd, fmsub
(define_insn_reservation "msa_long_float8" 8
  (eq_attr "msa_execunit" "msa_eu_float8")
  "apc_fpu_long, apc_fpu_float_a, apc_fpu_float_b, apc_fpu_float_c, apc_fpu_float_d")

;; Vector mul, dotp, madd, msub
(define_insn_reservation "msa_long_mult" 5
  (eq_attr "msa_execunit" "msa_eu_mult")
  "apc_fpu_long, apc_fpu_mult")

;; fdiv, fmod (semi-pipelined)
(define_insn_reservation "msa_long_fdiv" 10
  (eq_attr "msa_execunit" "msa_eu_fdiv")
  "apc_fpu_long, nothing, nothing, apc_fpu_fdiv*8")

;; div, mod (not-pipelined)
(define_insn_reservation "msa_long_div" 10
  (eq_attr "msa_execunit" "msa_eu_div")
  "apc_fpu_long, apc_fpu_div*9, apc_fpu_div + apc_fpu_logic_a")

;;
;; FPU pipe
;;

;; fadd, fsub
(define_insn_reservation "apc_fpu_fadd" 4
  (eq_attr "type" "fadd,fabs,fneg")
  "apc_fpu_long, apc_fpu_apu")

;; fabs, fneg, fcmp
(define_insn_reservation "apc_fpu_fabs" 2
  (eq_attr "type" "fabs,fneg,fcmp,fmove")
  "apc_fpu_short, apc_fpu_apu")

;; fload
(define_insn_reservation "apc_fpu_fload" 8
  (and (eq_attr "type" "fpload,fpidxload")
    (eq_attr "mode" "!TI"))
  "apc_fpu_long, apc_fpu_apu")

;; fstore
(define_insn_reservation "apc_fpu_fstore" 1
  (and (eq_attr "type" "fpstore,fpidxstore")
    (eq_attr "mode" "!TI"))
  "apc_fpu_short, apc_fpu_apu")

;; fmadd
(define_insn_reservation "apc_fpu_fmadd" 9
  (eq_attr "type" "fmadd")
  "apc_fpu_long, apc_fpu_apu")

;; fmul
(define_insn_reservation "apc_fpu_fmul" 5
  (eq_attr "type" "fmul")
  "apc_fpu_long, apc_fpu_apu")

;; fdiv, fsqrt
(define_insn_reservation "apc_fpu_fdiv" 17
  (eq_attr "type" "fdiv,frdiv,fsqrt,frsqrt")
  "apc_fpu_long, apc_fpu_apu*17")

;; fcvt
(define_insn_reservation "apc_fpu_fcvt" 4
  (eq_attr "type" "fcvt")
  "apc_fpu_long, apc_fpu_apu")

;; mtc
(define_insn_reservation "apc_fpu_fmtc" 7
  (eq_attr "type" "mtc")
  "apc_fpu_short, apc_fpu_store")

;; mfc
(define_insn_reservation "apc_fpu_fmfc" 4
  (eq_attr "type" "mfc")
  "apc_fpu_short, apc_fpu_store")

;; madd/msub feeding into the add source.
;; madd.fmt dst, x, x, x -> madd.fmt x, dst, x, x 5 cycles
(define_bypass 5 "apc_fpu_fmadd" "apc_fpu_fmadd" "mips_fmadd_bypass")

;;
;; Integer pipe
;;

;; AND
(define_insn_reservation "apc_int_and" 1
  (eq_attr "move_type" "logical")
  "alq_alu")

;; LUI
(define_insn_reservation "apc_int_lui" 1
  (eq_attr "move_type" "const")
  "alq_alu")

;; Load LB, LBU, LH, LHU, LQ, LW, LW_I2F, LWXS
(define_insn_reservation "apc_int_load" 4
  (eq_attr "move_type" "load")
  "agq_ldsta")

;; store
(define_insn_reservation "apc_int_store" 3
  (eq_attr "move_type" "store")
  "agq_ldsta")

;; ANDI, SLL, SRL, SEB, SEH
(define_insn_reservation "apc_int_arith_2" 1
  (eq_attr "move_type" "andi,sll0,signext")
  "agq_al2 | alq_alu")

;; ADDI, ADDIU, ORI, XORI, ADD, ADDU
(define_insn_reservation "apc_int_arith_1" 1
  (eq_attr "alu_type" "add,or,xor")
  "agq_al2 | alq_alu")

;; NOR, SUB
(define_insn_reservation "apc_int_arith_4" 1
  (eq_attr "alu_type" "nor,sub")
  "alq_alu")

;; SRL, SRA, ROTR, SLT, SLLV, SRLV
(define_insn_reservation "apc_int_arith_3" 1
  (eq_attr "type" "shift,slt,move")
  "agq_al2 | alq_alu")

;; NOP
(define_insn_reservation "apc_int_nop" 0
  (eq_attr "type" "nop")
  "agq_al2")

;; CLO CLZ
(define_insn_reservation "apc_int_countbits" 1
  (eq_attr "type" "clz")
  "agq_al2")

;; Conditional moves
(define_insn_reservation "apc_int_condmove" 1
  (eq_attr "type" "condmove")
  "agq_al2")

;; MADD MSUB
(define_insn_reservation "apc_dsp_mac" 5
  (eq_attr "type" "imadd")
  "agq_al2")

;; MFHI/LO
(define_insn_reservation "apc_dsp_mfhilo" 1
  (eq_attr "type" "mfhi,mflo")
  "agq_al2")

;; MTHI/LO
(define_insn_reservation "apc_dsp_mthilo" 5
  (eq_attr "type" "mthi,mtlo")
  "agq_al2")

;; MULT MULTU MUL
(define_insn_reservation "apc_dsp_mult" 5
  (eq_attr "type" "imul3,imul")
  "agq_al2")

;; branch and jump
(define_insn_reservation "apc_int_branch" 1
  (eq_attr "type" "branch,jump")
  "agq_ctistd")

;; prefetch
(define_insn_reservation "apc_int_prefetch" 3
  (eq_attr "type" "prefetch,prefetchx")
  "agq_ldsta")

;; devide
(define_insn_reservation "apc_int_div" 8
  (eq_attr "type" "idiv")
  "agq_al2+apc_agq_div*8")

;; arith
(define_insn_reservation "apc_int_arith_5" 2
  (eq_attr "type" "arith")
  "agq_al2")

;; call
(define_insn_reservation "apc_int_call" 2
  (eq_attr "jal" "indirect,direct")
  "agq_ctistd")
