;; DFA-based pipeline description for MIPS32 models M6200.
;;
;; Copyright (C) 2015 Free Software Foundation, Inc.
;;
;; This file is part of GCC.
;;
;; GCC is free software; you can redistribute it and/or modify it
;; under the terms of the GNU General Public License as published
;; by the Free Software Foundation; either version 3, or (at your
;; option) any later version.

;; GCC is distributed in the hope that it will be useful, but WITHOUT
;; ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
;; or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public
;; License for more details.

;; You should have received a copy of the GNU General Public License
;; along with GCC; see the file COPYING3.  If not see
;; <http://www.gnu.org/licenses/>.

(define_automaton "m62_alu_pipe, m62_mdu_pipe, m62_fpu_pipe")
(define_cpu_unit "m62_mul" "m62_mdu_pipe")
(define_cpu_unit "m62_alu" "m62_alu_pipe")
(define_cpu_unit "m62_fpu" "m62_fpu_pipe")

;; --------------------------------------------------------------
;; ALU Instructions
;; --------------------------------------------------------------

;; ALU: Logicals
(define_insn_reservation "m62_int_logical" 1
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "logical,move,signext,slt"))
  "m62_alu")

;; Arithmetics
(define_insn_reservation "m62_int" 1
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "arith,const,shift,clz"))
  "m62_alu")

(define_insn_reservation "m62_int_nop" 0
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "nop"))
  "nothing")

;; Conditional move
(define_insn_reservation "m62_int_cmove" 1
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "condmove")
	    (eq_attr "mode" "SI,DI")))
  "m62_alu")

;; Call
(define_insn_reservation "m62_int_call" 1
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "call"))
  "m62_alu")

;; branch/jump
(define_insn_reservation "m62_int_jump" 1
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "branch,jump"))
  "m62_alu")

;; loads: lb, lbu, lh, lhu, ll, lw, lwl, lwr, lwpc, lwxs
;; prefetch: prefetch, prefetchx
(define_insn_reservation "m62_int_load" 2
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "load,multimem,prefetch,prefetchx"))
  "m62_alu")

;; stores
(define_insn_reservation "m62_int_store" 1
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "store,multimem"))
  "m62_alu")

;; load->next use :  2 cycles (Default)
;; load->load base:  3 cycles
;; load->store base: 3 cycles
;; load->store:	     1 cycles
(define_bypass 3 "m62_int_load" "m62_int_load")
(define_bypass 3 "m62_int_load" "m62_int_store" "!mips_store_data_bypass_p")
(define_bypass 1 "m62_int_load" "m62_int_store" "mips_store_data_bypass_p")

;; ALU->load base:   2 cycles
;; ALU->store base:  2 cycles
(define_bypass 2 "m62_int" "m62_int_load")
(define_bypass 2 "m62_int_logical" "m62_int_load")
(define_bypass 2 "m62_int_cmove" "m62_int_load")
(define_bypass 2 "m62_int" "m62_int_store" "!mips_store_data_bypass_p")
(define_bypass 2 "m62_int_logical" "m62_int_store" "!mips_store_data_bypass_p")
(define_bypass 2 "m62_int_cmove" "m62_int_store" "!mips_store_data_bypass_p")

;; --------------------------------------------------------------
;; MDU Instructions
;; --------------------------------------------------------------

;; High performance fully pipelined multiplier
;; MULT to HI/LO
(define_insn_reservation "m62_int_mult" 2
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "imul,imadd"))
  "m62_alu+m62_mul*2")

;; MUL to GPR
(define_insn_reservation "m62_int_mul3" 2
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "imul3"))
  "(m62_alu*2)+(m62_mul*2)")

;; mfhi, mflo
(define_insn_reservation "m62_int_mfhilo" 1
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "mfhi,mflo"))
  "m62_mul")

;; mthi, mtlo
(define_insn_reservation "m62_int_mthilo" 1
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "mthi,mtlo"))
  "m62_mul")

;; div
(define_insn_reservation "m62_int_div_si" 34
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "idiv"))
  "m62_alu+m62_mul*34")

(define_bypass 2 "m62_int" "m62_int_mul3")
(define_bypass 3 "m62_int_load" "m62_int_mul3")
(define_bypass 2 "m62_int" "m62_int_mult")
(define_bypass 3 "m62_int_load" "m62_int_mult")
;; --------------------------------------------------------------
;; Floating Point Instructions
;; --------------------------------------------------------------

;; fadd, fabs, fneg
(define_insn_reservation "m62_fadd" 4
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "fadd,fabs,fneg"))
  "m62_fpu")

;; fmove
(define_insn_reservation "m62_fmove" 4
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "fmove"))
  "m62_fpu")

;; conditional move
(define_insn_reservation "m62_fp_cmove" 4
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "condmove")
	    (eq_attr "mode" "SF,DF")))
  "m62_fpu")

;; fload
(define_insn_reservation "m62_fload" 3
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "fpload,fpidxload"))
  "m62_fpu")

;; fstore
(define_insn_reservation "m62_fstore" 1
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "fpstore,fpidxstore"))
  "m62_fpu")

;; fmul, fmadd
(define_insn_reservation "m62_fmul_sf" 4
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "fmul,fmadd")
	    (eq_attr "mode" "SF")))
  "m62_fpu")

(define_insn_reservation "m62_fmul_df" 5
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "fmul,fmadd")
	    (eq_attr "mode" "DF")))
  "m62_fpu*2")

;; fdiv, fsqrt
(define_insn_reservation "m62_fdiv_sf" 17
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "fdiv,fsqrt")
	    (eq_attr "mode" "SF")))
  "m62_fpu*14")

(define_insn_reservation "m62_fdiv_df" 32
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "fdiv,fsqrt")
	    (eq_attr "mode" "DF")))
  "m62_fpu*29")

;; frsqrt
(define_insn_reservation "m62_frsqrt_sf" 17
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "frsqrt")
	    (eq_attr "mode" "SF")))
  "m62_fpu*14")

(define_insn_reservation "m62_frsqrt_df" 35
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "frsqrt")
	    (eq_attr "mode" "DF")))
  "m62_fpu*31")

;; fcmp
(define_insn_reservation "m62_fcmp" 4
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "fcmp"))
  "m62_fpu")

;; fcvt
;; cvt.s.d
(define_insn_reservation "m62_fcvt_6" 6
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "fcvt")
	    (eq_attr "cnv_mode" "D2S")))
  "m62_fpu")

;; trunc
(define_insn_reservation "m62_fcvt_5" 5
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "fcvt")
	    (eq_attr "cnv_mode" "D2I,S2I")))
  "m62_fpu")

;; cvt
(define_insn_reservation "m62_fcvt_4" 4
  (and (eq_attr "cpu" "m6200")
       (and (eq_attr "type" "fcvt")
	    (eq_attr "cnv_mode" "S2D,I2D,I2S")))
  "m62_fpu")

;; mtc, mfc
(define_insn_reservation "m62_move_to_from_c1" 2
  (and (eq_attr "cpu" "m6200")
       (eq_attr "type" "mtc, mfc"))
  "m62_fpu")
